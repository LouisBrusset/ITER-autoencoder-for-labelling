<!DOCTYPE html>
<html lang="fr">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoencoder - Anomaly Detection</title>
    <link rel="stylesheet" href="styles/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Autoencoder - Anomaly Detection</h1>
            <nav class="navigation">
                <a href="#section-data" class="nav-link active">1. Data</a>
                <a href="#section-checking" class="nav-link">2. Checking</a>
                <a href="#section-training" class="nav-link">3. Training</a>
                <a href="#section-visualization" class="nav-link">4. Visualization</a>
                <a href="#section-classification" class="nav-link">5. Classification</a>
            </nav>
        </header>

        <!-- SECTION 1 : DATA -->
        <section id="section-data" class="section active">
            <h2>1. Data loading</h2>
            
            <div class="card">
                <h3>Upload a file</h3>
                <input type="file" id="fileUpload" accept=".csv,.npz">
                <button onclick="uploadData()" class="btn-primary">Upload</button>
                <div id="uploadStatus"></div>
            </div>
            
            <div class="card">
                <h3>or create synthetic data</h3>
                <div class="form-group">
                    <label>Number of samples:</label>
                    <input type="number" id="nSamples" value="2000" min="100" max="10000">
                </div>
                <div class="form-group">
                    <label>Data dimension:</label>
                    <input type="number" id="inputDim" value="50" min="5" max="100">
                </div>
                <div class="form-group">
                    <label>Number of anomalies:</label>
                    <input type="number" id="nAnomalies" value="100" min="0" max="200">
                </div>
                <div class="form-group">
                    <label>Validation ratio (0-0.9):</label>
                    <input type="number" id="valRatio" value="0.5" step="0.05" min="0" max="0.9">
                </div>
                <button onclick="createSyntheticData()" class="btn-primary">Create data</button>
            </div>

            <div class="card">
                <h3>Available Data</h3>
                <div id="dataOptions"></div>
                <div id="currentDataset" class="status-info">
                    No dataset loaded
                </div>
            </div>
        </section>

        <!-- SECTION 2 : CHECKING -->
        <section id="section-checking" class="section">
            <h2>2. Data checking</h2>

            <div class="card">
                <h3>Dataset Information</h3>
                <div id="checkingDatasetStatus" class="status-info">No dataset loaded</div>
            </div>

            <div class="card">
                <h3>Sample selector</h3>
                <div class="form-group">
                    <label>Sample index (0-based):</label>
                    <input type="number" id="checkSampleIndex" value="0" min="0">
                </div>
                <div class="form-group radio-group">
                    <label>Sample subset:</label>
                    <div>
                        <label><input type="radio" name="checkSubset" value="train" checked> Train only</label>
                        <label><input type="radio" name="checkSubset" value="all"> All (global index)</label>
                    </div>
                </div>
                <button onclick="showSamplePlot(document.getElementById('checkSampleIndex').value)" class="btn-primary">Show sample</button>
                <button onclick="showRandomSample()" class="btn-secondary">Random sample</button>
            </div>

            <div class="card">
                <h3>Sample visualization</h3>
                <div id="checkPlotContainer" style="text-align:center;">
                    <img id="checkPlot" src="" alt="Sample plot will appear here" style="max-width:100%; height:auto;"/>
                </div>
            </div>
        </section>

        <!-- SECTION 3 : TRAINING -->
        <section id="section-training" class="section">
            <h2>3. Training the Model</h2>

            <div class="card">
                <h3>Dataset Information</h3>
                <div id="trainingDatasetInfo" class="status-info">
                    No dataset loaded for training
                </div>
            </div>
            
            <div class="card">
                <h3>Training Parameters</h3>
                <div class="form-group">
                    <label>Number of epochs:</label>
                    <input type="number" id="trainingEpochs" value="60" min="10" max="1000">
                </div>
                <div class="form-group">
                    <label>Learning rate:</label>
                    <input type="number" id="learningRate" value="0.01" step="0.0001" min="0.0001" max="0.1">
                </div>
                <div class="form-group">
                    <label>Latent dimension:</label>
                    <input type="number" id="encodingDim" value="5" min="2" max="20">
                </div>
                <div class="form-group">
                    <label>Encoder layers (max 4):</label>
                    <input type="number" id="encoderLayersCount" value="1" min="0" max="4">
                    <div id="encoderLayersContainer" style="margin-top:6px;"></div>
                </div>
                <div class="form-group">
                    <label>Convolutional encoder - nombre de couches (0 = pas de conv):</label>
                    <input type="number" id="convLayersCount" value="0" min="0" max="10">
                </div>
                <div class="form-group">
                    <label>Taille des filtres (kernel size) pour toutes les couches:</label>
                    <input type="number" id="convFilterSize" value="3" min="1" max="15">
                </div>
                <div class="form-group">
                    <label>Beta (poids KLD pour VAE, ex: 0.01):</label>
                    <input type="number" id="betaValue" value="0.01" step="0.0001" min="0" max="10">
                </div>
                <div class="form-group">
                    <label>Decoder layers (max 5):</label>
                    <input type="number" id="decoderLayersCount" value="1" min="0" max="5">
                    <div id="decoderLayersContainer" style="margin-top:6px;"></div>
                </div>
                <button onclick="startTraining()" class="btn-primary" id="startTrainingBtn">Start Training</button>
            </div>
            
            <div class="card">
                <h3>Training Progress</h3>
                <div class="status">
                    <p>Status: <span id="statusText">Waiting...</span></p>
                    <p>Epoch: <span id="epochText">0</span>/<span id="totalEpochs">0</span></p>
                    <p>Current Losses: <span id="lossText">0.0000</span></p>
                </div>
                <div style="position: relative; height:400px; width:100%;">
                    <canvas id="trainingChart"></canvas>
                </div>
                <button onclick="resetTraining()" class="btn-warning">Reset</button>
            </div>
            
            <div class="card">
                <h3>Available Saved Models</h3>
                <div id="modelOptions"></div>
                <button onclick="loadSelectedModel()" class="btn-secondary">Load Selected Model</button>
                <div id="currentModelStatus" class="status-info">
                    No model loaded
                </div>
            </div>

            <div class="card">
                <h3>Inference</h3>
                <div style="margin-bottom:8px;">
                    <label style="margin-right:8px;"><input type="checkbox" id="inferenceDeterministic" checked> Deterministic UMAP</label>
                </div>
                <button onclick="runInference()" class="btn-success" id="runInferenceBtn" style="background-color:rgb(62, 173, 62); color:white">Inference</button>
                <div id="inferenceStatus" class="status-info">Inference not run</div>
            </div>

            <div class="card">
                <h3>Available Inference</h3>
                <div id="inferenceOptions">Loading available inference...</div>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <button onclick="loadSelectedInference()" class="btn-secondary">Load Selected Inference</button>
                    <button onclick="deleteSelectedInference()" class="btn-warning">Delete Selected Inference</button>
                </div>
                <div id="inferenceActionStatus" class="status-info" style="margin-top:6px">No inference loaded</div>
            </div>
        </section>



        <!-- SECTION 4 : VISUALIZATION -->
        <section id="section-visualization" class="section">
            <h2>4. Latent Space Visualization</h2>

            <div class="card">
                <h3>Dataset Information</h3>
                <div id="visualizationDatasetInfo" class="status-info">
                    No dataset loaded for visualization
                </div>
            </div>
            
            <div class="card">
                <h3>Model Information</h3>
                <div id="visualizationModelInfo" class="status-info">
                    No model loaded for visualization
                </div>
            </div>
            <div class="card">
                <h3>Inference Status</h3>
                <div id="inferenceStatusViz" class="status-info">Inference not checked</div>
            </div>
            
            <div class="card">
                <h3>2D Projection of Latent Space</h3>
                <div class="form-group radio-group">
                    <label>Projection subset:</label>
                    <div>
                        <label><input type="radio" name="visSubset" value="train"> Train</label>
                        <label><input type="radio" name="visSubset" value="validation" checked> Validation</label>
                        <label><input type="radio" name="visSubset" value="all"> All</label>
                    </div>
                </div>
                <button onclick="generateLatentSpace()" class="btn-primary">Load Visualization</button>
                <div id="pointInfo" class="point-info">
                    Hover over the points to see details.
                </div>
                <div style="position: relative; height:600px; width:100%;">
                    <canvas id="latentSpaceChart"></canvas>
                </div>
                <div class="card">
                    <h4>Sample reconstruction</h4>
                    <div style="position: relative; height:300px; width:100%;">
                        <canvas id="reconstructionChart"></canvas>
                    </div>
                    <div id="reconInfo" class="point-info">
                        Click a point in the latent space to see its reconstruction.
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 5 : CLASSIFICATION -->
        <section id="section-classification" class="section">
            <h2>5. Classification</h2>
                <div class="card">
                <h3>Dataset Information</h3>
                <div id="classificationDatasetInfo" class="status-info">No dataset loaded for classification</div>
            </div>

            <div class="card">
                <h3>Model Information</h3>
                <div id="classificationModelInfo" class="status-info">No model loaded for classification</div>
            </div>

            <div class="card">
                <h3>Inference Status</h3>
                <div id="classificationInferenceStatus" class="status-info">Inference not checked</div>
            </div>

            <div class="card">
                <h3>2D Projection (select to label)</h3>
                <div class="form-group radio-group">
                    <label>Projection subset:</label>
                    <div>
                        <label><input type="radio" name="classSubset" value="train"> Train</label>
                        <label><input type="radio" name="classSubset" value="validation" checked> Validation</label>
                        <label><input type="radio" name="classSubset" value="all"> All</label>
                    </div>
                </div>
                <button onclick="generateClassificationLatentSpace()" class="btn-primary">Load Projections</button>
                <button onclick="applyClassificationColors()" class="btn-secondary" id="applyLabelsBtn" disabled>Apply new labels</button>
                <button onclick="saveLabels()" class="btn-success" id="saveLabelsBtn" disabled>Save labels</button>
                <button onclick="extractAllLabels()" class="btn-success" id="extractAllBtn" style="background-color:rgb(62, 173, 62); color:white">Export all labels</button>
                <div id="classificationContainer" style="position:relative; height:600px; width:100%;">
                    <canvas id="classificationChart"></canvas>
                    <!-- overlay canvas for drawing selection polygon -->
                    <canvas id="classificationOverlay" style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
                </div>
                <div id="classificationInfo" class="point-info">Drag to draw a polygon to select points.</div>
            </div>
        </section>

        <footer class="app-footer">
            <button id="prevSectionBtn" class="footer-nav-btn" disabled>← Previous</button>
            <button id="nextSectionBtn" class="footer-nav-btn">Next →</button>
        </footer>
    </div>



    <!-- External scripts: split by feature area for readability and maintenance -->
    <script>window.API_BASE = "http://localhost:8000";</script>
    <script src="scripts/script_data.js"></script>
    <script src="scripts/script_checking.js"></script>
    <script src="scripts/script_training.js"></script>
    <script src="scripts/script_visualization.js"></script>
    <script src="scripts/script_classification.js"></script>
    <script>
                // Lightweight bootstrap: wire nav and run DOM initializers if present
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                navigateToSection(targetId);
            });
        });

        // Navigation functions for footer buttons
        function navigateToSection(sectionId) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Activate the target section and its nav link
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`a[href="#${sectionId}"]`).classList.add('active');
            
            // Update footer buttons state
            updateFooterButtons(sectionId);
            
            // Call specific initialization if needed
            if (sectionId === 'section-classification' && window.syncOverlayToChart) window.syncOverlayToChart();
            // Scroll to top of page when changing section so the user always
            // starts at the top of the new view.
            // Use smooth behavior if supported.
            try {
                window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
            } catch (e) {
                // Fallback for older browsers
                window.scrollTo(0, 0);
            }
        }
        
        function updateFooterButtons(currentSectionId) {
            const sections = [
                'section-data', 
                'section-checking', 
                'section-training', 
                'section-visualization', 
                'section-classification'
            ];
            
            const currentIndex = sections.indexOf(currentSectionId);
            const prevBtn = document.getElementById('prevSectionBtn');
            const nextBtn = document.getElementById('nextSectionBtn');
            
            // Update previous button
            if (currentIndex > 0) {
                prevBtn.disabled = false;
                prevBtn.onclick = () => navigateToSection(sections[currentIndex - 1]);
            } else {
                prevBtn.disabled = true;
                prevBtn.onclick = null;
            }
            
            // Update next button
            if (currentIndex < sections.length - 1) {
                nextBtn.disabled = false;
                nextBtn.onclick = () => navigateToSection(sections[currentIndex + 1]);
            } else {
                nextBtn.disabled = true;
                nextBtn.onclick = null;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with the first section
            updateFooterButtons('section-data');
            // Init functions
            if (window.loadDataOptions) loadDataOptions();
            if (window.checkCurrentDataset) checkCurrentDataset();
            if (window.loadModelOptions) loadModelOptions();
            if (window.checkCurrentModel) checkCurrentModel();
            if (window.loadInferenceOptions) loadInferenceOptions();
            if (window.checkInferenceStatus) checkInferenceStatus();
            if (window.initTrainingChart) initTrainingChart();
            if (window.initLatentSpaceChart) initLatentSpaceChart();
            if (window.initReconstructionChart) initReconstructionChart();
            // Initialize classification overlay
            const overlay = document.getElementById('classificationOverlay');
            if (overlay) overlay.style.pointerEvents = 'auto';
        });
    </script>
</body>
</html>